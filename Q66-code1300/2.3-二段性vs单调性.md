# 二段性 vs 单调性：二分查找的本质

## 核心观点

**二分的本质是二段性，而非单调性**

## 什么是二段性？

**二段性**：存在一个**分界点**，使得分界点左边和右边满足**不同的性质**。

```
[满足条件A的区域] | [不满足条件A的区域]
      ←─────────|─────────→
        分界点
```

## 什么是单调性？

**单调性**：函数值随着自变量**单调递增或递减**。

```
f(x) 单调递增：
f(1) < f(2) < f(3) < f(4) < ...
```

## 两者的关系

### 单调性 → 二段性（充分条件）

如果函数 `f(x)` 单调递增，那么对于任意 `target`，必然存在分界点：
- 左边：`f(x) <= target`
- 右边：`f(x) > target`

**但反过来不成立！** 二段性不一定需要单调性。

### 二段性 ≠ 单调性（更本质）

**只要存在二段性，就可以二分！**

例子：山峰数组（先增后减）
```
[1, 3, 5, 7, 5, 3, 1]
     ↑
   峰值
```
- ❌ 不单调（先增后减）
- ✅ 但可以二分找峰值（左边 < 峰值，右边 < 峰值）

---

## 这道题中的二段性体现

### 题目：找到 value，使得 `calSum(value)` 最接近 `target`

### 二段性的定义

**分界点**：存在一个 `val0`，使得：
- 左边：`calSum(val) <= target`  ✅
- 右边：`calSum(val) > target`  ❌

```
val:  0    1    2    3    4    5    6  ...
sum:  0    3    6    9   11   12   12 ...
      └─────────────┘    └──────────┘
      calSum <= target   calSum > target
              ↑
           分界点 val0 = 3
```

### 具体分析（arr = [2,3,5], target = 10）

```
value | calSum(value) | calSum <= 10? | 性质
------|----------------|---------------|------
  0   |       0        |      ✅       | 满足条件
  1   |       3        |      ✅       | 满足条件
  2   |       6        |      ✅       | 满足条件
  3   |       8        |      ✅       | 满足条件
  4   |       9        |      ✅       | 满足条件
  5   |      10        |      ✅       | 满足条件 ← 分界点左侧
  6   |      10        |      ❌       | 不满足条件 ← 分界点右侧
  7   |      10        |      ❌       | 不满足条件
```

**二段性体现：**
- **分界点左侧**：`calSum(val) <= 10` 的所有 `val`（0, 1, 2, 3, 4, 5）
- **分界点右侧**：`calSum(val) > 10` 的所有 `val`（6, 7, 8, ...）

**注意**：这里 `val = 5` 是最后一个满足 `calSum <= 10` 的值，`val = 6` 是第一个不满足的值。

### 为什么说二段性更本质？

#### 1. 单调性只是充分条件

虽然这道题中 `calSum(val)` 是单调递增的，但：
- ✅ **二段性**：存在分界点，左边 `<= target`，右边 `> target`
- ✅ **单调性**：`calSum` 单调递增（只是帮助我们理解为什么有二段性）

**关键**：即使 `calSum` 不是严格单调的，只要存在二段性，就可以二分！

#### 2. 实际例子：非单调但有二段性

假设 `calSum` 函数是这样的（虽然这道题不会出现）：
```
val:  0    1    2    3    4    5
sum:  5    8    6    9   10   12
      ❌   ✅   ✅   ✅   ✅   ❌
      └─────────────┘
      calSum <= 10
```

虽然不单调（2→6, 3→9），但**仍然有二段性**：
- 左边：`calSum <= 10`
- 右边：`calSum > 10`

**仍然可以二分！**

#### 3. 这道题的特殊性

在这道题中，`calSum(val)` 确实是单调递增的：
- `val` 增大 → 更多元素被限制为 `val` → `calSum` 增大

但**二分的依据是二段性，不是单调性**：
- 我们利用的是：存在分界点，左边满足条件，右边不满足
- 而不是：函数单调递增

---

## 代码中的体现

### 二分查找的核心逻辑

```typescript
let l = 0, r = arr.at(-1) + 1
while (l + 1 < r) {
  const val = (l + r) >> 1
  calSum(val) <= target ? l = val : r = val  // ← 利用二段性
}
```

**二段性的利用：**
- `calSum(val) <= target` → `val` 在分界点左侧 → `l = val`
- `calSum(val) > target` → `val` 在分界点右侧 → `r = val`

**不变量：**
- `l`：已确认满足条件的最大值（分界点左侧）
- `r`：已确认不满足条件的最小值（分界点右侧）

### 为什么可以二分？

因为存在**二段性**：
- 存在分界点 `val0`
- 左边：`calSum(val) <= target`
- 右边：`calSum(val) > target`

**不需要知道函数是否单调，只需要知道有二段性！**

---

## 总结对比

| 特性 | 二段性 | 单调性 |
|------|--------|--------|
| **定义** | 存在分界点，左右满足不同性质 | 函数值单调递增/递减 |
| **是否必需** | ✅ 二分查找的**必要条件** | ❌ 只是**充分条件** |
| **本质性** | ✅ **更本质**，直接描述分界点 | 只是帮助理解 |
| **适用范围** | 更广（包括非单调情况） | 较窄（只适用于单调函数） |
| **这道题** | ✅ 存在二段性（左边 `<= target`，右边 `> target`） | ✅ 也存在单调性（`calSum` 递增） |

### 关键理解

1. **二段性是二分的本质**：只要存在分界点，就可以二分
2. **单调性是二段性的充分条件**：单调函数必然有二段性
3. **但二段性不要求单调性**：非单调函数也可能有二段性
4. **这道题中**：虽然 `calSum` 单调递增，但我们利用的是二段性，不是单调性

### 记忆技巧

- **二段性** = "分界点"的存在
- **单调性** = "函数单调变化"
- **二分查找** = 利用"二段性"找"分界点"
- **单调性**只是帮助我们理解为什么有二段性，但不是必需的

---

## 延伸思考

### 其他有二段性但不单调的例子

1. **山峰数组找峰值**
   ```
   [1, 3, 5, 7, 5, 3, 1]
   ```
   - ❌ 不单调
   - ✅ 有二段性（左边递增，右边递减）

2. **旋转排序数组找最小值**
   ```
   [4, 5, 6, 7, 0, 1, 2]
   ```
   - ❌ 不单调
   - ✅ 有二段性（左边 >= 第一个元素，右边 < 第一个元素）

**核心**：只要存在分界点，就可以二分！

